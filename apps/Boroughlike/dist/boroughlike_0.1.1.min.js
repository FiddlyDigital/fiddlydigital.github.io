const t=0,e=1,s=2,i=3,r="AssetsLoaded",a="KeyPress",h="PlayerLose",n="PlayerWin",o="GameOver",l="GameWin",c="Loading",p="Running",u="Title",d=0,f={Player:0,Player_Dead:1,Bird:2,Snake:3,Tank:4,Eater:5,Jester:6,HP:7,MonsterLoad:8,Turret_N:9,Turret_E:10,Turret_S:11,Turret_W:12},g={BOOK:"book.wav",MONSTERHIT:"hit2.wav",NEWLEVEL:"newLevel.wav",PLAYERHIT:"hit1.wav",SPELL:"spell.wav"},S="effect",w="item",m="Monster",y="tile",v=0,b=1,T=2,x=4,k=5,M=6;class P{constructor(){if(!P.instance){this.sounds={};for(let[t,e]of Object.entries(g))this.sounds[e]=null;P.instance=this}return P.instance}initSounds(){for(let[t,e]of Object.entries(g))this.sounds[e]=new Audio(`assets/sounds/${e}`)}playSound(t){t&&this.sounds[t]&&(this.sounds[t].currentTime=0,this.sounds[t].play())}}const A=new P;Object.freeze(A);class E{constructor(t,e){this.stateMatrix=t,this.currentState={name:""},this.previousState=null,this.enterState(e)}triggerEvent(t){let e=this.currentState.getNewState(t);e&&this.enterState(e)}enterState(t){t!==this.currentState.name&&(this.currentState.onExit&&this.currentState.onExit(),this.previousState=this.currentState,this.currentState=this.stateMatrix[t],this.currentState.onEnter&&this.currentState.onEnter())}}class L{constructor(t,e,s,i){this.name=t||"",this.transformations=e||{},this.onEnter=s,this.onExit=i}getNewState(t){return t=t||"",!!this.transformations[t]&&this.transformations[t]}}class N{static tryTo(t,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+t}static randomRange(t,e){return Math.floor(Math.random()*(e-t+1))+t}static shuffle(t){let e,s;for(let i=1;i<t.length;i++)s=N.randomRange(0,i),e=t[i],t[i]=t[s],t[s]=e;return t}static rightPad(t){let e="";return t.forEach(t=>{for(let e=(t+="").length;e<10;e++)t+=" ";e+=t}),e}}class C{constructor(){return C.instance||(this.monsterSpriteSheet=new Image,this.tileSpriteSheet=new Image,this.effectSpriteSheet=new Image,this.itemSpriteSheet=new Image,this.callback={onLoadCompleted:null},this.shake={amount:0,x:0,y:0},this.canvas=document.querySelector("canvas"),this.ctx=this.canvas.getContext("2d"),C.instance=this),C.instance}initSpriteSheet(t){this.callback.onLoadCompleted=t,this.monsterSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.tileSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.effectSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.itemSpriteSheet.onload=this.checkAllSpriteSheetsLoaded.bind(this),this.monsterSpriteSheet.src="assets/images/monsters.png",this.tileSpriteSheet.src="assets/images/library.png",this.effectSpriteSheet.src="assets/images/effects.png",this.itemSpriteSheet.src="assets/images/items.png"}checkAllSpriteSheetsLoaded(){this.monsterSpriteSheet.complete&&this.tileSpriteSheet.complete&&this.effectSpriteSheet.complete&&this.itemSpriteSheet.complete&&this.callback.onLoadCompleted()}setupCanvas(){this.canvas.width=960,this.canvas.height=768,this.canvas.style.width=this.canvas.width+"px",this.canvas.style.height=this.canvas.height+"px",this.ctx.imageSmoothingEnabled=!1}getSpriteSheet(t){switch(t){case m:return this.monsterSpriteSheet;case y:return this.tileSpriteSheet;case S:return this.effectSpriteSheet;case w:return this.itemSpriteSheet}}drawSprite(t,e,s,i,r){t===S&&r&&r>0&&(this.ctx.globalAlpha=r/30),this.ctx.drawImage(this.getSpriteSheet(t),16*e,0,16,16,64*s+this.shake.x,64*i+this.shake.y,64,64),t===S&&(!r||r<=0)&&(this.ctx.globalAlpha=1)}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}screenshake(){this.shake.amount&&this.shake.amount--;let t=Math.random()*Math.PI*2;this.shake.x=Math.round(Math.cos(t)*this.shake.amount),this.shake.y=Math.round(Math.sin(t)*this.shake.amount)}drawDarkBackground(){this.clearCanvas(),this.ctx.fillStyle="rgba(0,0,0,.75)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}showTitle(t){this.drawDarkBackground(),this.drawSprite(w,d,6,1),this.drawSprite(m,f.Player,7,1),this.drawSprite(w,d,8,1),this.drawText("Boroughlike",64,!0,this.canvas.height/2-150,"white"),this.drawText("Arrow Keys or WASD to Move",32,!0,this.canvas.height/2-90,"white"),this.drawText("1-9 to use spells",32,!0,this.canvas.height/2-40,"white"),t&&t.length>0&&this.drawScores(t),this.drawText("Press any key to continue...",20,!0,this.canvas.height-40,"white")}showGameWin(t){this.drawDarkBackground(),this.drawSprite(w,d,6,1),this.drawSprite(m,f.Player,7,1),this.drawSprite(w,d,8,1),this.drawText("Congratulations",64,!0,this.canvas.height/2-150,"white"),this.drawText("You successfully escaped the Library",32,!0,this.canvas.height/2-90,"white"),this.drawText("Press any key to continue...",20,!0,this.canvas.height-40,"white")}showGameLose(t){this.drawDarkBackground(),this.drawSprite(S,e,6,1),this.drawSprite(m,f.Player_Dead,7,1),this.drawSprite(S,e,8,1),this.drawText("You didn't make it...",64,!0,this.canvas.height/2-150,"white"),this.drawText("Better luck next time!",32,!0,this.canvas.height/2-90,"white"),this.drawText("Press any key to continue...",20,!0,this.canvas.height-40,"white")}updateSidebar(t,e,s){O.drawText("Level: "+t,30,!1,40,"violet"),O.drawText("Books: "+e,30,!1,70,"violet");for(let t=0;t<s.length;t++){let e=t+1+") "+(s[t]||"");O.drawText(e,20,!1,110+40*t,"aqua")}}drawText(t,e,s,i,r){let a;this.ctx.fillStyle=r,this.ctx.font=e+"px monospace",a=s?(this.canvas.width-this.ctx.measureText(t).width)/2:this.canvas.width-192+25,this.ctx.fillText(t,a,i)}drawScores(t){this.drawText(N.rightPad(["RUN","BOOKS","TOTAL"]),18,!0,this.canvas.height/2,"white");let e=t.pop();t.sort((function(t,e){return e.totalScore-t.totalScore})),t.unshift(e);for(let e=0;e<Math.min(10,t.length);e++){let s=N.rightPad([t[e].run,t[e].score,t[e].totalScore]);this.drawText(s,18,!0,this.canvas.height/2+24+24*e,0==e?"aqua":"violet")}}setShakeAmount(t){this.shake.amount=t}}const O=new C;Object.freeze(O);class D{constructor(t,e,s,i){this.x=t,this.y=e,this.sprite=s,this.passable=i}dist(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}getNeighbor(t,e){return V.getTile(this.x+t,this.y+e)}getAdjacentNeighbors(){return N.shuffle([this.getNeighbor(0,-1),this.getNeighbor(0,1),this.getNeighbor(-1,0),this.getNeighbor(1,0)])}getNeighbourChain(t){let e=[0,0];switch(t){case"N":e=[0,-1];break;case"S":e=[0,1];break;case"E":e=[1,0];break;case"W":e=[-1,0]}let s=[],i=this;for(;null!=i;)i=i.getNeighbor(e[0],e[1]),i instanceof j?i=null:s.push(i);return s}getAdjacentPassableNeighbors(){return this.getAdjacentNeighbors().filter(t=>t.passable)}getConnectedTiles(){let t=[this],e=[this];for(;e.length;){let s=e.pop().getAdjacentPassableNeighbors().filter(e=>!t.includes(e));t=t.concat(s),e=e.concat(s)}return t}draw(){O.drawSprite(y,this.sprite,this.x,this.y),this.book&&O.drawSprite(w,d,this.x,this.y),this.effectCounter&&(this.effectCounter--,O.drawSprite(S,this.effect,this.x,this.y,this.effectCounter))}setEffect(t){this.effect=t,this.effectCounter=30}}class R extends D{constructor(t,e){super(t,e,v,!0)}stepOn(t){t.isPlayer&&this.book&&($.incrementScore(),this.book=!1)}}class j extends D{constructor(t,e){super(t,e,b,!1)}}class B extends D{constructor(t,e){super(t,e,T,!0)}stepOn(t){t.isPlayer&&$.nextLevel()}}class W extends D{constructor(t,e){super(t,e,x,!0)}stepOn(t){t.isPlayer&&O.setShakeAmount(5),t.hit(1)}}class Y extends D{constructor(t,e){super(t,e,k,!0),this.isActive=!0}stepOn(t){this.isActive&&t.isPlayer&&(this.isActive=!1,this.sprite=M,t.heal(10))}}const G={WOOP:function(t){t.move(V.randomPassableTile())},QUAKE:function(t){for(let e=0;e<12;e++)for(let s=0;s<12;s++){let i=V.getTile(e,s);if(i.monster&&i.monster!=t){let t=4-i.getAdjacentPassableNeighbors().length;i.monster.hit(2*t)}}O.setShakeAmount(20)},TORNADO:function(){for(let t=0;t<V.getMonsters().length;t++)V.getMonsters()[t].move(V.randomPassableTile()),V.getMonsters()[t].teleportCounter=2},AURA:function(e){e.tile.getAdjacentNeighbors().forEach((function(e){e.setEffect(t),e.monster&&e.monster.heal(1)})),e.tile.setEffect(t),e.heal(3)},DASH:function(t){let s=t.tile;for(;;){let e=s.getNeighbor(t.lastMove[0],t.lastMove[1]);if(!e.passable||e.monster)break;s=e}t.tile!=s&&(t.move(s),s.getAdjacentNeighbors().forEach(t=>{t.monster&&(t.setEffect(e),t.monster.stunned=!0,t.monster.hit(1))}))},FLATTEN:function(t){for(let t=1;t<11;t++)for(let e=1;e<11;e++){V.getTile(t,e).passable||V.replaceTile(t,e,R)}t.tile.setEffect(e),t.heal(2)},ALCHEMY:function(t){t.tile.getAdjacentNeighbors().forEach((function(t){!t.passable&&V.inBounds(t.x,t.y)&&(V.replaceTile(t.x,t.y,R),V.getTile(t.x,t.y).book=!0)}))},POWERATTACK:function(t){t.bonusAttack=5},PROTECT:function(t){t.shield=2;for(let t=0;t<V.getMonsters().length;t++)V.getMonsters()[t].stunned=!0},BOLT:function(t){H(t,t.lastMove,15+Math.abs(t.lastMove[1]),4)},CROSS:function(t){let e=[[0,-1],[0,1],[-1,0],[1,0]];for(let r=0;r<e.length;r++){let a=0==Math.abs(e[r][1])?s:i;H(t,e[r],a,2)}},EX:function(t){let s=[[-1,-1],[-1,1],[1,-1],[1,1]];for(let i=0;i<s.length;i++)H(t,s[i],e,3)}};function H(t,e,s,i){let r=t.tile;for(;;){let t=r.getNeighbor(e[0],e[1]);if(!t.passable)break;r=t,r.monster&&r.monster.hit(i),r.setEffect(s)}}class I{constructor(t,e,s){this.move(t),this.sprite=e,this.hp=s,this.teleportCounter=2,this.offsetX=0,this.offsetY=0,this.lastMove=[-1,0],this.bonusAttack=0}heal(t){this.hp=Math.min(6,this.hp+t),this.isPlayer}update(){this.teleportCounter--,this.stunned||this.teleportCounter>0?this.stunned=!1:this.doStuff()}doStuff(){let t=this.tile.getAdjacentPassableNeighbors();t=t.filter(t=>!t.monster||t.monster.isPlayer);let e=$.getPlayerTile();if(t.length){t.sort((t,s)=>t.dist(e)-s.dist(e));let s=t[0];this.tryMove(s.x-this.tile.x,s.y-this.tile.y)}}getDisplayX(){return this.tile.x+this.offsetX}getDisplayY(){return this.tile.y+this.offsetY}draw(){this.teleportCounter>0?O.drawSprite(m,f.MonsterLoad,this.getDisplayX(),this.getDisplayY()):(O.drawSprite(m,this.sprite,this.getDisplayX(),this.getDisplayY()),this.drawHp()),this.offsetX-=Math.sign(this.offsetX)*(1/8),this.offsetY-=Math.sign(this.offsetY)*(1/8)}drawHp(){for(let t=0;t<this.hp;t++)O.drawSprite(m,f.HP,this.getDisplayX()+t%3*(5/16),this.getDisplayY()-Math.floor(t/3)*(5/16))}tryMove(t,e){let s=this.tile.getNeighbor(t,e);if(s.passable)return this.lastMove=[t,e],s.monster?this.isPlayer!=s.monster.isPlayer&&(this.attackedThisTurn=!0,s.monster.stunned=!0,s.monster.hit(1+this.bonusAttack),this.bonusAttack=0,O.setShakeAmount(5),this.offsetX=(s.x-this.tile.x)/2,this.offsetY=(s.y-this.tile.y)/2):this.move(s),!0}hit(t){this.shield>0||(this.hp-=t,this.hp<=0&&(this.die(),this.tile instanceof R&&(this.tile.book=!0)),this.isPlayer?A.playSound(g.PLAYERHIT):A.playSound(g.MONSTERHIT))}die(){this.dead=!0,this.tile.monster=null,this.isPlayer&&(this.sprite=1)}move(t){this.tile&&(this.tile.monster=null,this.offsetX=this.tile.x-t.x,this.offsetY=this.tile.y-t.y),this.tile=t,t.monster=this,t.stepOn(this)}}class K extends I{constructor(t){super(t,f.Player,3),this.isPlayer=!0,this.teleportCounter=0,this.spells=N.shuffle(Object.keys(G)).splice(0,$.props.numSpells)}update(){this.shield--}tryMove(t,e){super.tryMove(t,e)&&$.tick()}addSpell(){let t=N.shuffle(Object.keys(G))[0];this.spells.push(t)}castSpell(t){let e=this.spells[t];e&&(delete this.spells[t],G[e](this),A.playSound(g.SPELL),$.tick())}}class X extends I{constructor(t){super(t,f.Bird,3)}}class F extends I{constructor(t){super(t,f.Snake,1)}doStuff(){this.attackedThisTurn=!1,super.doStuff(),this.attackedThisTurn||super.doStuff()}}class _ extends I{constructor(t){super(t,f.Tank,2)}update(){let t=this.stunned;super.update(),t||(this.stunned=!0)}}class U extends I{constructor(t){super(t,f.Eater,1)}doStuff(){let t=this.tile.getAdjacentNeighbors().filter(t=>!t.passable&&V.inBounds(t.x,t.y));t.length?(V.replaceTile(t[0].x,t[0].y,R),this.heal(.5)):super.doStuff()}}class q extends I{constructor(t){super(t,f.Jester,2)}doStuff(){let t=this.tile.getAdjacentPassableNeighbors();t.length&&this.tryMove(t[0].x-this.tile.x,t[0].y-this.tile.y)}}class z extends I{constructor(t){super(t,f.Turret,1),this.directions=["N","E","S","W"],this.currentDirection=N.randomRange(0,3)}doStuff(){this.currentDirection+=1,4==this.currentDirection&&(this.currentDirection=0);let t=this.directions[this.currentDirection];this.sprite=f["Turret_"+t];var e=this.tile.getNeighbourChain(t);e.some(t=>t.monster&&t.monster.isPlayer)&&e.forEach(e=>{switch(e.monster&&e.monster.hit(1),t){case"N":case"S":e.setEffect(i);break;case"E":case"W":e.setEffect(s)}})}}class J{constructor(){return J.instance||(this.props={monsters:[],tiles:[],level:1},J.instance=this),J.instance}replaceTile(t,e,s){return this.props.tiles[t][e]=new s(t,e),this.props.tiles[t][e]}tiles(){return this.props.tiles}getMonsters(){return this.props.monsters}generateLevel(t){this.props.level=t,N.tryTo("generate map",(function(){return V.generateTiles()==V.randomPassableTile().getConnectedTiles().length})),this.generateMonsters();for(var e=0;e<3;){let t=this.randomPassableTile();t instanceof R&&(e++,t.book=!0)}}generateTiles(){let t=0;this.props.tiles=[];for(let e=0;e<12;e++){this.props.tiles[e]=[];for(let s=0;s<12;s++)Math.random()<.3||!this.inBounds(e,s)?this.props.tiles[e][s]=new j(e,s):(Math.random()<.02?this.props.tiles[e][s]=new W(e,s):Math.random()<.005?this.props.tiles[e][s]=new Y(e,s):this.props.tiles[e][s]=new R(e,s),t++)}return t}inBounds(t,e){return t>0&&e>0&&t<11&&e<11}getTile(t,e){return this.inBounds(t,e)?this.props.tiles[t][e]:new j(t,e)}randomPassableTile(){let t;return N.tryTo("get random passable tile",(function(){let e=N.randomRange(0,11),s=N.randomRange(0,11);return t=V.getTile(e,s),t.passable&&!t.monster})),t}generateMonsters(){this.props.monsters=[];let t=Math.ceil(this.props.level/2)+1;for(let e=0;e<t;e++)this.spawnMonster()}spawnMonster(){let t=new(0,N.shuffle([X,F,_,U,q,z])[0])(this.randomPassableTile());this.props.monsters.push(t)}}const V=new J;Object.freeze(V);class Q{constructor(){if(!Q.instance){this.version="0.1.1",this.props={level:1,numSpells:1,player:null,score:0,spawnCounter:0,spawnRate:15};const t={};t[c]=new L(c,{AssetsLoaded:u},this.loadAssets),t[u]=new L(u,{KeyPress:p},this.showTitle.bind(this)),t[p]=new L(p,{PlayerLose:o,PlayerWin:l},this.startGame.bind(this)),t[o]=new L(o,{KeyPress:u},this.showGameLose.bind(this)),t[l]=new L(l,{KeyPress:u},this.showGameWin.bind(this)),this.FSM=new E(t,c),Q.instance=this}return Q.instance}init(){O.setupCanvas(),this.addEventHandlers(),setInterval(this.draw.bind(this),15)}loadAssets(){A.initSounds(),O.initSpriteSheet((function(){$.FSM.triggerEvent(r)}))}addEventHandlers(){document.querySelector("html").onkeydown=function(t){switch($.FSM.currentState.name){case l:case o:case u:$.FSM.triggerEvent(a);break;case p:$.handleKeypress(t)}}}handleKeypress(t){if(!(t=t||window.event).defaultPrevented)switch(t.key){case"Up":case"ArrowUp":case"w":case"W":this.props.player.tryMove(0,-1);break;case"Down":case"ArrowDown":case"s":case"S":this.props.player.tryMove(0,1);break;case"Left":case"ArrowLeft":case"a":case"A":this.props.player.tryMove(-1,0);break;case"Right":case"ArrowRight":case"d":case"D":this.props.player.tryMove(1,0);break;case" ":this.props.player.tryMove(0,0);break;case 1:case"1":case 2:case"2":case 3:case"3":case 4:case"4":case 5:case"5":case 6:case"6":case 7:case"7":case 8:case"8":case 9:case"9":this.props.player.castSpell(parseInt(t.key)-1)}}draw(){if(this.FSM.currentState.name==p){O.clearCanvas(),O.screenshake();for(let t=0;t<12;t++)for(let e=0;e<12;e++)V.getTile(t,e).draw();for(let t=0;t<V.getMonsters().length;t++)V.getMonsters()[t].draw();this.props.player.draw(),O.updateSidebar(this.props.level,this.props.score,this.props.player.spells)}}tick(){if(this.FSM.currentState.name==p){for(let t=V.getMonsters().length-1;t>=0;t--)V.getMonsters()[t].dead?V.getMonsters().splice(t,1):V.getMonsters()[t].update();this.props.player.update(),this.props.player.dead&&(this.addScore(this.props.score,!1),this.FSM.triggerEvent(h)),this.props.spawnCounter--,this.props.spawnCounter<=0&&(V.spawnMonster(),this.props.spawnCounter=this.props.spawnRate,this.props.spawnRate--)}}showTitle(){O.showTitle(this.getScores())}showGameWin(){this.addScore(this.props.score,!0),O.showGameWin(this.props.score)}showGameLose(){this.addScore(this.props.score,!0),O.showGameLose(this.props.score)}startGame(){this.props.level=1,this.props.score=0,this.props.numSpells=1,this.startLevel(3)}startLevel(t,e){this.props.spawnRate=15,this.props.spawnCounter=this.props.spawnRate,V.generateLevel(this.props.level),this.props.player=new K(V.randomPassableTile()),this.props.player.hp=t,e&&(this.props.player.spells=e);let s=V.randomPassableTile();V.replaceTile(s.x,s.y,B)}addScore(t,e){let s=this.getScores(),i={score:t,run:1,totalScore:t,active:e},r=s.pop();r&&(r.active?(i.run=r.run+1,i.totalScore+=r.totalScore):s.push(r)),s.push(i),localStorage.scores=JSON.stringify(s)}getScores(){return localStorage.scores?JSON.parse(localStorage.scores):[]}nextLevel(){10==this.props.level?this.FSM.triggerEvent(n):(A.playSound(g.NEWLEVEL),this.props.level++,this.startLevel(Math.min(6,this.props.player.hp+1)))}incrementScore(){A.playSound(g.BOOK),this.props.score++,this.props.score%3==0&&this.props.numSpells<9&&(this.props.numSpells++,this.props.player.addSpell()),V.spawnMonster()}getPlayerTile(){return this.props.player.tile}}const $=new Q;Object.freeze($);export default $;
